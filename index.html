<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TamalApp - Doña Santa</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome (Iconos) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- html2canvas (Generador de Imágenes) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        mexican: {
                            pink: '#E4007C',
                            yellow: '#FFD700',
                            green: '#006847',
                            clay: '#B54B26',
                            dark: '#1a1a1a',
                            corn: '#eec04b'
                        }
                    },
                    fontFamily: {
                        'ticket': ['Courier Prime', 'monospace'],
                        'sans': ['Montserrat', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&family=Courier+Prime:wght@400;700&display=swap');
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #fdf6e3;
            background-image: radial-gradient(#d4a373 1px, transparent 1px);
            background-size: 20px 20px;
            overscroll-behavior-y: contain; 
            -webkit-tap-highlight-color: transparent;
        }

        .cintillo-mexicano {
            height: 12px;
            background: linear-gradient(90deg, #006847 33%, #ffffff 33%, #ffffff 66%, #E4007C 66%);
            background-size: 60px 100%;
        }

        .card-shadow {
            box-shadow: 8px 8px 0px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .card-shadow:active {
            transform: translateY(2px);
            box-shadow: 4px 4px 0px rgba(0,0,0,0.1);
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(4px);
        }

        /* Estilos Ticket */
        .ticket-header-font { font-family: 'Montserrat', sans-serif; font-weight: 900; }
        .ticket-mono-font { font-family: 'Courier Prime', monospace; }
        .ticket-folio-box { border: 2px solid #000; border-radius: 8px; padding: 4px 12px; display: inline-block; }
        .ticket-divider-thick { border-bottom: 3px solid #000; }
        .ticket-divider-thin { border-bottom: 1px solid #000; }
        .ticket-dotted-line { border-bottom: 2px dotted #aaa; }

        /* Checkbox Personalizado (Estilo Ticket) */
        .check-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            color: #4b5563;
        }
        .check-group input[type="checkbox"] {
            width: 1.2em;
            height: 1.2em;
            accent-color: #E4007C;
        }
    </style>
</head>
<body class="text-gray-800 pb-20 select-none relative">

    <!-- NAVBAR -->
    <div class="cintillo-mexicano w-full sticky top-0 z-40"></div>
    <div class="bg-gray-900 text-white py-4 px-4 shadow-xl relative overflow-hidden border-b-4 border-mexican-pink z-30">
        <div class="max-w-7xl mx-auto flex items-center justify-between relative z-10">
            <div class="flex items-center gap-3">
                <div class="bg-white text-mexican-pink p-2 rounded-lg relative overflow-hidden">
                    <i class="fas fa-receipt text-2xl relative z-10"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black uppercase leading-none">TAMALAPP</h1>
                    <p class="text-xs text-gray-400 font-bold uppercase flex items-center gap-1">
                        Doña Santa <i class="fas fa-heart text-red-500 text-[10px]"></i>
                    </p>
                </div>
            </div>
            <div class="hidden md:block">
                <p class="text-[10px] font-mono text-gray-400" id="systemDate">--</p>
            </div>
        </div>
    </div>

    <!-- CONTENIDO -->
    <div class="max-w-5xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-6 mt-6 relative z-10">
        
        <!-- FORMULARIOS -->
        <div class="lg:col-span-7 space-y-6">
            
            <!-- CONFIGURACIÓN DE PRECIOS -->
            <div class="bg-white p-4 rounded-2xl border-2 border-gray-100 card-shadow form-group-container">
                <div class="flex items-center gap-2 mb-4 border-b border-gray-100 pb-2">
                    <i class="fas fa-cog text-gray-400"></i>
                    <h2 class="font-bold text-gray-700 text-sm uppercase">Precios del Día</h2>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 block mb-1">GENERAL</label>
                        <input type="number" id="priceGeneral" value="14" onchange="recalc()" class="w-full border-2 border-orange-100 rounded-lg px-2 py-2 text-center font-bold text-lg focus:border-orange-500 outline-none text-gray-800 input-enter-target">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 block mb-1">BLANCOS</label>
                        <input type="number" id="priceBlancos" value="2" onchange="recalc()" class="w-full border-2 border-blue-100 rounded-lg px-2 py-2 text-center font-bold text-lg focus:border-blue-500 outline-none text-gray-800 input-enter-target">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 block mb-1">ADICIONES</label>
                        <input type="number" id="priceAdiciones" value="0" onchange="recalc()" class="w-full border-2 border-green-100 rounded-lg px-2 py-2 text-center font-bold text-lg focus:border-green-500 outline-none text-gray-800 input-enter-target">
                    </div>
                </div>
            </div>

            <!-- DATOS CLIENTE -->
            <div class="bg-white p-4 rounded-2xl border-2 border-gray-100 card-shadow form-group-container">
                <div class="flex items-center gap-2 mb-4 border-b border-gray-100 pb-2">
                    <i class="fas fa-user text-gray-400"></i>
                    <h2 class="font-bold text-gray-700 text-sm uppercase">Datos del Cliente</h2>
                </div>
                <div class="space-y-3">
                    <input type="text" id="customerName" placeholder="NOMBRE COMPLETO" class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-3 font-bold uppercase text-sm focus:bg-white focus:border-mexican-pink outline-none transition-colors input-enter-target">
                    
                    <div class="grid grid-cols-2 gap-3">
                        <input type="tel" id="customerPhone1" placeholder="TELÉFONO" class="bg-gray-50 border-2 border-gray-200 rounded-xl px-3 py-2 text-sm font-bold focus:bg-white outline-none input-enter-target">
                        <input type="tel" id="customerPhone2" placeholder="TEL. OPCIONAL" class="bg-gray-50 border-2 border-gray-200 rounded-xl px-3 py-2 text-sm font-bold focus:bg-white outline-none input-enter-target">
                    </div>

                    <div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-200">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Fecha Entrega</label>
                            <input type="date" id="deliveryDate" class="w-full bg-white border border-gray-300 rounded-lg px-2 py-1 text-xs font-bold mt-1 input-enter-target">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Hora Entrega</label>
                            <input type="time" id="deliveryTime" class="w-full bg-white border border-gray-300 rounded-lg px-2 py-1 text-xs font-bold mt-1 input-enter-target">
                        </div>
                    </div>
                </div>
            </div>

            <!-- NOTAS GENERALES -->
            <div class="bg-white p-4 rounded-2xl border-2 border-blue-100 card-shadow">
                <div class="flex items-center gap-2 mb-3 border-b border-blue-50 pb-2">
                    <i class="fas fa-clipboard-check text-blue-400"></i>
                    <h2 class="font-bold text-gray-700 text-sm uppercase">Notas de Preparación (General)</h2>
                </div>
                <div class="flex flex-wrap gap-4 mb-3 check-group">
                    <label><input type="checkbox" id="checkCerdo"> CERDO</label>
                    <label><input type="checkbox" id="checkPapas"> PAPAS</label>
                    <label><input type="checkbox" id="checkPollo"> POLLO</label>
                </div>
                <input type="text" id="notesExtra" placeholder="Escribir nota extra (Ej. Sin picante...)" class="w-full bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 text-xs font-bold text-gray-700 focus:bg-white outline-none input-enter-target uppercase">
            </div>

            <!-- PEDIDO -->
            <div class="bg-white p-4 rounded-2xl border-2 border-gray-100 card-shadow">
                <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-utensils text-gray-400"></i>
                        <h2 class="font-bold text-gray-700 text-sm uppercase">Armar Pedido</h2>
                    </div>
                    <button onclick="addNewFlavorRow()" class="text-[10px] bg-green-50 text-green-700 border border-green-200 px-3 py-1 rounded-full font-bold hover:bg-green-100 flex items-center gap-1">
                        <i class="fas fa-plus"></i> AGREGAR
                    </button>
                </div>
                
                <div class="space-y-4" id="flavorsContainer">
                    <!-- Filas JS -->
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA: TOTAL -->
        <div class="lg:col-span-5">
            <div class="sticky top-6">
                <div class="bg-gray-900 text-white p-6 rounded-3xl shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i class="fas fa-coins text-6xl"></i>
                    </div>
                    
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Total Estimado</h3>
                    
                    <div class="flex flex-col items-center justify-center my-6">
                        <span class="text-5xl font-black tracking-tighter" id="uiTotalMoney">$0.00</span>
                        <div class="flex items-center gap-2 mt-2 text-gray-400 text-xs font-mono">
                            <span>MXN</span>
                            <span>•</span>
                            <span id="uiTotalQty">0 PIEZAS</span>
                        </div>
                    </div>

                    <button onclick="prepareTicketPreview()" class="w-full bg-gradient-to-r from-mexican-pink to-pink-600 hover:from-pink-600 hover:to-pink-700 text-white font-bold py-4 rounded-xl shadow-lg uppercase text-sm tracking-wide transition-transform active:scale-95 flex justify-center items-center gap-2">
                        <i class="fas fa-print"></i> Generar Ticket
                    </button>
                    
                    <button onclick="resetAll()" class="w-full mt-3 py-2 text-center text-[10px] text-gray-500 hover:text-white uppercase font-bold">
                        <i class="fas fa-trash mr-1"></i> Limpiar Todo
                    </button>
                </div>

                <div id="loading" class="hidden mt-4 bg-white/80 backdrop-blur p-4 rounded-xl text-center shadow-lg border border-gray-200">
                    <i class="fas fa-circle-notch fa-spin text-mexican-pink text-xl mb-2"></i>
                    <p class="text-xs font-bold text-gray-600">Imprimiendo...</p>
                </div>
            </div>
        </div>
    </div>


    <!-- ========================================== -->
    <!-- MODAL VISTA PREVIA -->
    <!-- ========================================== -->
    <div id="previewModal" class="fixed inset-0 z-[100] hidden modal-overlay flex flex-col justify-center items-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                <h3 class="font-bold text-gray-700 text-sm"><i class="fas fa-check-circle text-green-500 mr-1"></i> TICKET LISTO</h3>
                <button onclick="closePreview()" class="text-gray-400 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="flex-grow overflow-y-auto bg-gray-200 p-4 flex justify-center">
                <div id="finalTicketImageContainer" class="shadow-xl"></div>
            </div>

            <div class="p-4 border-t border-gray-200 bg-white space-y-3">
                <button onclick="shareImageDirectly()" class="w-full bg-[#25D366] hover:bg-[#128C7E] text-white font-bold py-3 rounded-xl shadow flex justify-center items-center gap-2 transition-transform active:scale-95">
                    <i class="fab fa-whatsapp text-xl"></i>
                    <span>COMPARTIR IMAGEN (WHATSAPP)</span>
                </button>
                <button onclick="forceDownload()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-3 rounded-xl text-xs flex justify-center items-center gap-2">
                    <i class="fas fa-download"></i> GUARDAR EN GALERÍA
                </button>
            </div>
        </div>
    </div>


    <!-- ========================================== -->
    <!-- TICKET HD OCULTO (PLANTILLA EXACTA CON MAZORCAS) -->
    <!-- ========================================== -->
    <div id="ticketContainer" style="position: fixed; top: -5000px; left: -5000px; width: 550px; z-index: 99999;">
        <div id="ticketContent" class="bg-white px-8 py-10 text-black relative overflow-hidden" style="width: 100%; min-height: 800px;">
            
            <!-- MAZORCAS LITERALES (SVG DETALLADO) -->
            <!-- Izquierda -->
            <div class="absolute top-4 left-6 w-16 opacity-90">
               <svg viewBox="0 0 100 150" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 10C30 30 15 80 25 120C35 135 65 135 75 120C85 80 70 30 50 10Z" fill="#FFD700" stroke="#DAA520" stroke-width="2"/>
                    <!-- Granos -->
                    <circle cx="40" cy="40" r="4" fill="#FFF8DC"/><circle cx="50" cy="40" r="4" fill="#FFF8DC"/><circle cx="60" cy="40" r="4" fill="#FFF8DC"/>
                    <circle cx="35" cy="55" r="4" fill="#FFF8DC"/><circle cx="45" cy="55" r="4" fill="#FFF8DC"/><circle cx="55" cy="55" r="4" fill="#FFF8DC"/><circle cx="65" cy="55" r="4" fill="#FFF8DC"/>
                    <circle cx="35" cy="70" r="4" fill="#FFF8DC"/><circle cx="45" cy="70" r="4" fill="#FFF8DC"/><circle cx="55" cy="70" r="4" fill="#FFF8DC"/><circle cx="65" cy="70" r="4" fill="#FFF8DC"/>
                    <circle cx="40" cy="85" r="4" fill="#FFF8DC"/><circle cx="50" cy="85" r="4" fill="#FFF8DC"/><circle cx="60" cy="85" r="4" fill="#FFF8DC"/>
                    <!-- Hojas -->
                    <path d="M25 120Q5 90 15 50" stroke="#228B22" stroke-width="5" fill="none"/>
                    <path d="M75 120Q95 90 85 50" stroke="#228B22" stroke-width="5" fill="none"/>
                    <path d="M25 120C10 130 10 140 50 145C90 140 90 130 75 120" fill="#228B22"/>
                </svg>
            </div>
            <!-- Derecha (Espejo) -->
            <div class="absolute top-4 right-6 w-16 opacity-90 transform scale-x-[-1]">
                <svg viewBox="0 0 100 150" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 10C30 30 15 80 25 120C35 135 65 135 75 120C85 80 70 30 50 10Z" fill="#FFD700" stroke="#DAA520" stroke-width="2"/>
                    <!-- Granos -->
                    <circle cx="40" cy="40" r="4" fill="#FFF8DC"/><circle cx="50" cy="40" r="4" fill="#FFF8DC"/><circle cx="60" cy="40" r="4" fill="#FFF8DC"/>
                    <circle cx="35" cy="55" r="4" fill="#FFF8DC"/><circle cx="45" cy="55" r="4" fill="#FFF8DC"/><circle cx="55" cy="55" r="4" fill="#FFF8DC"/><circle cx="65" cy="55" r="4" fill="#FFF8DC"/>
                    <circle cx="35" cy="70" r="4" fill="#FFF8DC"/><circle cx="45" cy="70" r="4" fill="#FFF8DC"/><circle cx="55" cy="70" r="4" fill="#FFF8DC"/><circle cx="65" cy="70" r="4" fill="#FFF8DC"/>
                    <circle cx="40" cy="85" r="4" fill="#FFF8DC"/><circle cx="50" cy="85" r="4" fill="#FFF8DC"/><circle cx="60" cy="85" r="4" fill="#FFF8DC"/>
                    <!-- Hojas -->
                    <path d="M25 120Q5 90 15 50" stroke="#228B22" stroke-width="5" fill="none"/>
                    <path d="M75 120Q95 90 85 50" stroke="#228B22" stroke-width="5" fill="none"/>
                    <path d="M25 120C10 130 10 140 50 145C90 140 90 130 75 120" fill="#228B22"/>
                </svg>
            </div>

            <!-- HEADER -->
            <div class="text-center mb-6 relative z-10 pt-2">
                <h1 class="ticket-header-font text-3xl uppercase tracking-wider text-black mb-1">SISTEMA DE CONTROL</h1>
                <p class="ticket-header-font text-sm text-gray-600 uppercase font-bold tracking-widest mb-4">DE PEDIDOS Y ENCARGOS</p>
                
                <div class="inline-block ticket-folio-box">
                    <p class="ticket-mono-font text-lg font-bold">FOLIO: <span id="folioNum">8405</span></p>
                </div>
            </div>

            <div class="ticket-divider-thick mb-4"></div>

            <!-- FECHA Y HORA -->
            <div class="flex justify-between items-end mb-1 ticket-dotted-line pb-1">
                <div class="text-left">
                    <p class="ticket-mono-font text-xs font-bold text-gray-500 uppercase">FECHA EMISIÓN:</p>
                    <p class="ticket-mono-font text-sm" id="ticketEmissionDate">--</p>
                </div>
                <div class="text-right">
                    <p class="ticket-mono-font text-xs font-bold text-gray-500 uppercase">HORA:</p>
                    <p class="ticket-mono-font text-sm" id="ticketEmissionTime">--</p>
                </div>
            </div>

            <!-- CLIENTE -->
            <div class="mt-4 mb-4">
                <p class="ticket-mono-font text-xs font-bold text-gray-500 uppercase mb-1">CLIENTE:</p>
                <p class="ticket-header-font text-xl uppercase" id="ticketClientName">--</p>
                <p class="ticket-mono-font text-xs text-gray-400 mt-1" id="ticketClientPhone"></p>
            </div>

            <!-- ENTREGA PROGRAMADA (CAJA GRIS) -->
            <div class="bg-gray-100 border-l-8 border-black p-4 mb-4">
                <p class="ticket-mono-font text-xs font-bold uppercase mb-2">ENTREGA PROGRAMADA:</p>
                <p class="ticket-header-font text-lg uppercase leading-tight" id="ticketDeliveryFull">--</p>
            </div>

            <!-- NOTAS GENERALES (CONTIENE...) -->
            <div class="mb-6 px-1" id="ticketGlobalNotesContainer">
                <p class="ticket-mono-font text-xs font-bold text-gray-800 uppercase leading-relaxed" id="ticketGlobalNotes">
                    <!-- Se llena con JS -->
                </p>
            </div>

            <!-- TABLA DE PRODUCTOS -->
            <table class="w-full mb-2">
                <thead>
                    <tr class="ticket-divider-thick">
                        <th class="ticket-header-font text-left text-sm uppercase pb-1 w-16">CANT</th>
                        <th class="ticket-header-font text-left text-sm uppercase pb-1">DESCRIPCIÓN</th>
                        <th class="ticket-header-font text-right text-sm uppercase pb-1 w-24">TOTAL</th>
                    </tr>
                </thead>
                <tbody id="ticketTbody">
                    <!-- Filas JS -->
                </tbody>
            </table>

            <div class="ticket-divider-thick mb-2"></div>

            <!-- TOTALES -->
            <div class="flex justify-between items-start mb-4">
                <p class="ticket-header-font text-2xl uppercase">TOTAL:</p>
                <div class="text-right">
                    <p class="ticket-header-font text-3xl" id="ticketTotalNum">$0.00</p>
                    <p class="ticket-mono-font text-xs font-bold text-gray-500 uppercase">MXN</p>
                </div>
            </div>

            <!-- IMPORTE CON LETRA -->
            <div class="mb-8">
                <p class="ticket-mono-font text-xs font-bold text-gray-500 uppercase mb-1">IMPORTE CON LETRA:</p>
                <p class="ticket-mono-font text-xs uppercase border-b border-gray-200 pb-1" id="ticketTotalLetters">--</p>
            </div>

            <!-- FOOTER PERSONALIZADO -->
            <div class="text-center mt-12 pb-4">
                <p class="ticket-header-font text-lg font-black uppercase mb-1">TAMALES DOÑA "SANTA"</p>
                <p class="ticket-mono-font text-xs text-black mb-2 font-bold">PEDIDOS: 465 162 4963</p>
                <p class="ticket-mono-font text-[10px] text-gray-500 uppercase">(Llamada o WhatsApp)</p>
                
                <div class="border-t border-black w-48 mx-auto pt-2 mt-6 mb-4">
                    <p class="ticket-mono-font text-sm text-gray-600">Firma de Recibido</p>
                </div>

                <p class="ticket-mono-font text-[9px] text-gray-400 mt-6 border-t border-dotted border-gray-300 pt-2">
                    ESTE NO ES UN COMPROBANTE FISCAL
                </p>
            </div>

        </div>
    </div>


    <!-- ========================================== -->
    <!-- LOGICA JAVASCRIPT -->
    <!-- ========================================== -->
    <script>
        // --- VARIABLES GLOBALES ---
        // Ya no hay opciones individuales en 'opts'
        let flavors = [
            { id: 1, name: 'VERDE', type: 'general', qty: 0 },
            { id: 2, name: 'MOLE', type: 'general', qty: 0 },
            { id: 3, name: 'RAJAS CON QUESO', type: 'general', qty: 0 },
            { id: 4, name: 'BLANCOS', type: 'blancos', qty: 0 }
        ];

        let currentTicketBlob = null;
        let currentTicketFileName = "";

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            renderFlavors();
            setDates();
            document.getElementById('folioNum').innerText = Math.floor(1000 + Math.random() * 9000);
            recalc();
            setupEnterNavigation(); // Activamos la navegación con ENTER
        });

        // Configuración de tecla ENTER para saltar campos
        function setupEnterNavigation() {
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    const target = event.target;
                    // Solo si es un input marcado con nuestra clase
                    if (target.matches('.input-enter-target')) {
                        event.preventDefault(); // Evitar submit
                        const inputs = Array.from(document.querySelectorAll('.input-enter-target'));
                        const index = inputs.indexOf(target);
                        if (index > -1 && index < inputs.length - 1) {
                            inputs[index + 1].focus();
                            // Si es text/number, seleccionar todo el texto para facilitar edición
                            if(inputs[index+1].type === 'text' || inputs[index+1].type === 'number' || inputs[index+1].type === 'tel') {
                                inputs[index+1].select();
                            }
                        }
                    }
                }
            });
        }

        function setDates() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const delEl = document.getElementById('deliveryDate');
            if(delEl) delEl.value = today;
            
            const sysEl = document.getElementById('systemDate');
            if(sysEl) sysEl.innerText = now.toLocaleDateString('es-MX', {weekday:'long', day:'numeric', month:'long', year:'numeric'}).toUpperCase();
        }

        // --- RENDERIZADO DE FILAS DE SABORES (SIN CHECKBOXES) ---
        function renderFlavors() {
            const container = document.getElementById('flavorsContainer');
            container.innerHTML = '';
            
            flavors.forEach((item, index) => {
                const isFixed = index < 4;
                
                // Color borde
                let borderColor = "border-gray-200";
                let nameUpper = item.name.toUpperCase();
                if(nameUpper.includes("VERDE")) borderColor = "border-green-500 border-l-4";
                else if(nameUpper.includes("MOLE") || nameUpper.includes("ROJO")) borderColor = "border-red-700 border-l-4";
                else if(nameUpper.includes("RAJAS") || nameUpper.includes("PIÑA")) borderColor = "border-yellow-400 border-l-4";
                else if(nameUpper.includes("BLANCOS") || nameUpper.includes("DULCE")) borderColor = "border-slate-400 border-l-4";
                else borderColor = "border-blue-400 border-l-4";

                const div = document.createElement('div');
                div.className = `bg-white p-3 rounded-lg shadow-sm border ${borderColor} transition-all`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <!-- Cantidad -->
                        <div class="w-16">
                            <input type="number" min="0" value="${item.qty}" oninput="updateFlavorQty(${index}, this.value)" class="input-enter-target w-full text-center font-bold text-lg bg-gray-50 border border-gray-300 rounded-md py-1 focus:border-mexican-pink outline-none text-gray-800">
                        </div>
                        
                        <!-- Nombre -->
                        <div class="flex-grow">
                            ${isFixed 
                                ? `<span class="font-bold text-gray-800 text-sm uppercase block">${item.name}</span>`
                                : `<input type="text" value="${item.name}" onchange="updateFlavorName(${index}, this.value)" class="input-enter-target w-full bg-gray-50 border border-gray-300 rounded px-2 py-1 text-sm font-bold text-gray-700 uppercase outline-none" placeholder="NOMBRE SABOR">`
                            }
                        </div>
                        
                        <!-- Tipo Precio -->
                        <div class="w-20">
                            <select onchange="updateFlavorType(${index}, this.value)" class="w-full text-[10px] bg-gray-50 border border-gray-300 rounded py-1 font-bold text-gray-500 outline-none">
                                <option value="general" ${item.type === 'general' ? 'selected' : ''}>GEN</option>
                                <option value="blancos" ${item.type === 'blancos' ? 'selected' : ''}>BLANCOS</option>
                                <option value="adiciones" ${item.type === 'adiciones' ? 'selected' : ''}>ADICION</option>
                            </select>
                        </div>
                        
                        <!-- Botón Borrar (si no es fijo) -->
                        ${!isFixed ? `<button onclick="removeFlavor(${index})" class="text-red-400 px-1"><i class="fas fa-times"></i></button>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // CRUD
        function addNewFlavorRow() { flavors.push({ id: Date.now(), name: '', type: 'general', qty: 0 }); renderFlavors(); }
        function removeFlavor(index) { flavors.splice(index, 1); renderFlavors(); }
        function updateFlavorQty(index, val) { flavors[index].qty = parseInt(val) || 0; recalc(); }
        function updateFlavorType(index, val) { flavors[index].type = val; recalc(); }
        function updateFlavorName(index, val) { flavors[index].name = val; renderFlavors(); }

        // --- CÁLCULOS ---
        function recalc() {
            const priceGen = parseFloat(document.getElementById('priceGeneral').value) || 0;
            const priceBla = parseFloat(document.getElementById('priceBlancos').value) || 0;
            const priceAdi = parseFloat(document.getElementById('priceAdiciones').value) || 0;

            let totalQty = 0;
            let totalMoney = 0;

            flavors.forEach(f => {
                if(f.qty > 0) {
                    let price = 0;
                    if(f.type === 'general') price = priceGen;
                    else if(f.type === 'blancos') price = priceBla;
                    else if(f.type === 'adiciones') price = priceAdi;

                    totalQty += f.qty;
                    totalMoney += (f.qty * price);
                }
            });

            document.getElementById('uiTotalQty').innerText = totalQty + " PIEZAS";
            document.getElementById('uiTotalMoney').innerText = formatCurrency(totalMoney);
            
            return { totalMoney, totalQty, priceGen, priceBla, priceAdi };
        }

        // --- PREPARAR TICKET ---
        async function prepareTicketPreview() {
            const customer = document.getElementById('customerName').value.trim();
            const calcData = recalc();

            if(!customer) return alert("Falta Nombre del Cliente");
            if(calcData.totalQty === 0) return alert("El pedido está vacío");

            document.getElementById('loading').classList.remove('hidden');

            // 1. LLENAR DATOS
            const now = new Date();
            document.getElementById('ticketEmissionDate').innerText = now.toLocaleDateString('es-MX');
            document.getElementById('ticketEmissionTime').innerText = now.toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit', hour12:true}).toLowerCase();
            document.getElementById('ticketClientName').innerText = customer;
            
            const p1 = document.getElementById('customerPhone1').value;
            const p2 = document.getElementById('customerPhone2').value;
            const phoneText = (p1 || "") + (p2 ? " / "+p2 : "");
            document.getElementById('ticketClientPhone').innerText = phoneText ? `TEL: ${phoneText}` : "";

            // Fecha Entrega
            const dDate = document.getElementById('deliveryDate').value;
            const dTime = document.getElementById('deliveryTime').value;
            let dText = "PENDIENTE";
            if(dDate) {
                const [y,m,d] = dDate.split('-');
                const dateObj = new Date(y, m-1, d);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dText = dateObj.toLocaleDateString('es-MX', options).toUpperCase();
                
                if(dTime) {
                    const [th, tm] = dTime.split(':');
                    const h = parseInt(th);
                    const suf = h>=12 ? 'PM':'AM';
                    const h12 = h%12||12;
                    dText += ` A LAS ${h12}:${tm} ${suf}`;
                }
            }
            document.getElementById('ticketDeliveryFull').innerText = dText;

            // 2. LLENAR NOTAS GENERALES
            const hasCerdo = document.getElementById('checkCerdo').checked;
            const hasPapas = document.getElementById('checkPapas').checked;
            const hasPollo = document.getElementById('checkPollo').checked;
            const noteExtra = document.getElementById('notesExtra').value.trim();

            let notesArr = [];
            if(hasCerdo) notesArr.push("CARNE DE CERDO");
            if(hasPapas) notesArr.push("PAPAS");
            if(hasPollo) notesArr.push("POLLO");
            if(noteExtra) notesArr.push(noteExtra.toUpperCase());

            const notesEl = document.getElementById('ticketGlobalNotes');
            if(notesArr.length > 0) {
                notesEl.innerHTML = `<span class="border-b border-black pb-1">CONTIENE:</span> ${notesArr.join(", ")}`;
                document.getElementById('ticketGlobalNotesContainer').classList.remove('hidden');
            } else {
                notesEl.innerHTML = "";
                // Ocultar div si no hay notas para ahorrar espacio (opcional)
                // document.getElementById('ticketGlobalNotesContainer').classList.add('hidden');
            }

            // 3. TABLA PRODUCTOS
            const tbody = document.getElementById('ticketTbody');
            tbody.innerHTML = '';
            flavors.forEach(f => {
                if(f.qty > 0) {
                    let p = 0;
                    if(f.type === 'general') p = calcData.priceGen;
                    else if(f.type === 'blancos') p = calcData.priceBla;
                    else if(f.type === 'adiciones') p = calcData.priceAdi;

                    const totalRow = f.qty * p;
                    
                    tbody.innerHTML += `
                        <tr class="border-b border-gray-100">
                            <td class="ticket-mono-font font-bold align-top py-3 text-sm">${f.qty}</td>
                            <td class="align-top py-3">
                                <span class="ticket-mono-font font-bold text-sm uppercase block">${f.name}</span>
                                <span class="ticket-mono-font text-xs text-gray-500">($${p} C/U)</span>
                            </td>
                            <td class="ticket-mono-font font-bold text-right align-top py-3 text-sm">$${totalRow.toFixed(2)}</td>
                        </tr>
                    `;
                }
            });

            document.getElementById('ticketTotalNum').innerText = formatCurrency(calcData.totalMoney);
            document.getElementById('ticketTotalLetters').innerText = numeroALetras(calcData.totalMoney);

            // 4. GENERAR IMAGEN
            try {
                await new Promise(r => setTimeout(r, 200));
                const canvas = await html2canvas(document.getElementById('ticketContent'), {
                    scale: 2, 
                    backgroundColor: '#ffffff',
                    useCORS: true
                });

                canvas.toBlob(blob => {
                    currentTicketBlob = blob;
                    const safeName = customer.replace(/[^a-z0-9]/gi, '').substring(0,10);
                    currentTicketFileName = `PEDIDO_${safeName}.png`;
                    
                    const imgUrl = URL.createObjectURL(blob);
                    document.getElementById('finalTicketImageContainer').innerHTML = `<img src="${imgUrl}" class="w-full h-auto shadow-md">`;
                    
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('previewModal').classList.remove('hidden');
                }, 'image/png');

            } catch(e) {
                console.error(e);
                alert("Error generando el ticket");
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // --- COMPARTIR DIRECTO (WEB SHARE API) ---
        async function shareImageDirectly() {
            if(!currentTicketBlob) return alert("Primero genera el ticket");

            // Crear archivo físico en memoria
            const file = new File([currentTicketBlob], currentTicketFileName, { type: 'image/png' });

            // Verificar si el navegador soporta compartir archivos
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'Ticket de Pedido',
                        text: 'Aquí está el comprobante de tu pedido.'
                    });
                } catch (error) {
                    console.log('Error compartiendo:', error);
                }
            } else {
                // FALLBACK
                alert("Tu dispositivo no permite compartir la imagen directamente. Se descargará la imagen y abriremos WhatsApp.");
                
                forceDownload();
                setTimeout(() => {
                    window.open('https://api.whatsapp.com/send?text=Hola, adjunto tu ticket de pedido.', '_blank');
                }, 1000);
            }
        }

        function forceDownload() {
            if(!currentTicketBlob) return;
            const link = document.createElement('a');
            link.href = URL.createObjectURL(currentTicketBlob);
            link.download = currentTicketFileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function closePreview() { document.getElementById('previewModal').classList.add('hidden'); }
        
        function resetAll() {
            if(confirm('¿Borrar todo?')) {
                flavors.forEach(f => f.qty = 0);
                document.getElementById('customerName').value = '';
                document.getElementById('customerPhone1').value = '';
                document.getElementById('customerPhone2').value = '';
                document.getElementById('checkCerdo').checked = false;
                document.getElementById('checkPapas').checked = false;
                document.getElementById('checkPollo').checked = false;
                document.getElementById('notesExtra').value = '';
                renderFlavors();
                recalc();
            }
        }

        // UTILS
        function formatCurrency(n) { return new Intl.NumberFormat('es-MX', {style:'currency', currency:'MXN', minimumFractionDigits:2}).format(n); }
        
        function numeroALetras(n) {
            const ent = Math.floor(n);
            const dec = Math.round((n - ent) * 100);
            const centStr = dec.toString().padStart(2,'0') + "/100 M.N.";
            
            const u=["","UN","DOS","TRES","CUATRO","CINCO","SEIS","SIETE","OCHO","NUEVE"];
            const d=["","DIEZ","VEINTE","TREINTA","CUARENTA","CINCUENTA","SESENTA","SETENTA","OCHENTA","NOVENTA"];
            const c=["","CIENTO","DOSCIENTOS","TRESCIENTOS","CUATROCIENTOS","QUINIENTOS","SEISCIENTOS","SETECIENTOS","OCHOCIENTOS","NOVECIENTOS"];
            
            function convert(num) {
                if(num===0) return "CERO";
                if(num===100) return "CIEN";
                if(num<10) return u[num];
                if(num<20) return ["DIEZ","ONCE","DOCE","TRECE","CATORCE","QUINCE","DIECISEIS","DIECISIETE","DIECIOCHO","DIECINUEVE"][num-10];
                if(num<30) return "VEINTI" + u[num-20];
                if(num<100) return d[Math.floor(num/10)] + (num%10 ? " Y " + u[num%10] : "");
                if(num<1000) return c[Math.floor(num/100)] + (num%100 ? " " + convert(num%100) : "");
                if(num<1000000) {
                    let m=Math.floor(num/1000);
                    let str = (m===1?"MIL":convert(m)+" MIL");
                    if(num%1000) str += " " + convert(num%1000);
                    return str;
                }
                return "CANTIDAD GRANDE";
            }
            
            let txt = convert(ent);
            if(ent===1) txt="UN"; // Ajuste para "UN PESO"
            
            return `${txt} PESOS ${centStr}`;
        }
    </script>
</body>
</html>
