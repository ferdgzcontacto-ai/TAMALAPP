<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TamalApp - Gestión Profesional</title>
    
    <!-- LIBRERÍAS EXTERNAS -->
    <!-- Tailwind CSS: Para el diseño bonito y rápido -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome: Para los iconos (ticket, whatsapp, usuario) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- html2canvas: El motor que convierte el ticket HTML en Imagen PNG -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- CONFIGURACIÓN DE COLORES -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            pink: '#E4007C',   /* Rosa Mexicano */
                            yellow: '#FFD700', /* Amarillo Maíz */
                            green: '#006847',  /* Verde Bandera */
                            dark: '#1F2937'    /* Gris Oscuro */
                        }
                    }
                }
            }
        }
    </script>

    <!-- ESTILOS PERSONALIZADOS -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&family=Courier+Prime:wght@400;700&display=swap');
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #FFF8E1; /* Fondo crema suave */
            /* Patrón de puntos sutil */
            background-image: radial-gradient(#D4A373 1px, transparent 1px);
            background-size: 20px 20px;
            -webkit-tap-highlight-color: transparent;
        }

        /* Fuente monoespaciada tipo máquina de escribir para el ticket */
        .font-ticket {
            font-family: 'Courier Prime', monospace;
        }

        /* Decoración superior estilo sarape */
        .cintillo {
            height: 12px;
            background: linear-gradient(90deg, #006847 33%, #ffffff 33%, #ffffff 66%, #E4007C 66%);
            background-size: 60px 100%;
        }

        /* Efecto de sombra suave para tarjetas */
        .card-soft {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-bottom: 3px solid #E5E7EB;
        }

        /* Animación de carga */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="pb-24 text-gray-800">

    <!-- ========================================= -->
    <!-- ENCABEZADO / NAVBAR -->
    <!-- ========================================= -->
    <div class="cintillo w-full sticky top-0 z-50"></div>
    <div class="bg-gray-900 text-white p-4 shadow-xl sticky top-3 z-40 mx-2 rounded-xl mt-2 border border-gray-700">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-brand-pink p-2 rounded-lg text-white shadow-lg transform -rotate-6">
                    <i class="fas fa-clipboard-list text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black uppercase tracking-tighter leading-none">CONTROL DE PEDIDOS</h1>
                    <p class="text-[10px] text-brand-yellow font-bold tracking-widest uppercase">Sistema de Encargos</p>
                </div>
            </div>
            <!-- Fecha actual pequeña -->
            <div class="hidden md:block bg-white/10 px-3 py-1 rounded text-xs font-mono" id="systemHeaderDate">
                --/--/----
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- CONTENIDO PRINCIPAL -->
    <!-- ========================================= -->
    <div class="max-w-5xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 mt-2">
        
        <!-- COLUMNA IZQUIERDA: FORMULARIOS (8 columnas) -->
        <div class="lg:col-span-8 space-y-6">
            
            <!-- TARJETA 1: DATOS DEL CLIENTE -->
            <div class="bg-white p-5 rounded-2xl card-soft relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-brand-pink text-white text-[10px] font-bold px-3 py-1 rounded-bl-lg uppercase">Paso 1</div>
                
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <span class="w-8 h-8 bg-pink-100 text-brand-pink rounded-full flex items-center justify-center mr-2 text-sm"><i class="fas fa-user"></i></span>
                    Información del Cliente
                </h2>

                <div class="space-y-4">
                    <!-- Nombre -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Nombre Completo</label>
                        <input type="text" id="customerName" placeholder="Ej. Juan Pérez" class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 font-bold text-gray-800 focus:border-brand-pink focus:bg-white outline-none transition-colors uppercase">
                    </div>

                    <!-- Teléfonos -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Teléfono Principal</label>
                            <input type="tel" id="customerPhone1" placeholder="Ej. 449..." class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-3 py-2 font-bold text-gray-800 focus:border-brand-pink outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Teléfono Extra (Opc)</label>
                            <input type="tel" id="customerPhone2" placeholder="Opcional" class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-3 py-2 font-bold text-gray-800 focus:border-brand-pink outline-none">
                        </div>
                    </div>

                    <!-- Fecha de Entrega -->
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                        <label class="block text-xs font-bold text-blue-800 uppercase mb-2 text-center">¿Cuándo se entrega?</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="date" id="deliveryDate" class="bg-white border border-blue-200 rounded-lg px-2 py-2 text-sm font-bold text-center text-gray-700 focus:ring-2 focus:ring-blue-300 outline-none">
                            <input type="time" id="deliveryTime" class="bg-white border border-blue-200 rounded-lg px-2 py-2 text-sm font-bold text-center text-gray-700 focus:ring-2 focus:ring-blue-300 outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <!-- TARJETA 2: CONFIGURACIÓN DE PRECIOS -->
            <div class="bg-white p-5 rounded-2xl card-soft relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-brand-yellow text-gray-900 text-[10px] font-bold px-3 py-1 rounded-bl-lg uppercase">Config</div>
                
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <span class="w-8 h-8 bg-yellow-100 text-yellow-700 rounded-full flex items-center justify-center mr-2 text-sm"><i class="fas fa-coins"></i></span>
                    Precios del Día
                </h2>

                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <label class="text-xs font-bold text-gray-500 uppercase">General</label>
                        <div class="flex items-center">
                            <span class="text-gray-400 font-bold mr-1">$</span>
                            <input type="number" id="priceGeneral" value="20" onchange="recalculate()" class="w-16 text-right font-bold bg-transparent border-b-2 border-gray-300 focus:border-brand-yellow outline-none text-lg">
                        </div>
                    </div>
                    <div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <label class="text-xs font-bold text-gray-500 uppercase">Blancos/Esp</label>
                        <div class="flex items-center">
                            <span class="text-gray-400 font-bold mr-1">$</span>
                            <input type="number" id="priceSpecial" value="25" onchange="recalculate()" class="w-16 text-right font-bold bg-transparent border-b-2 border-gray-300 focus:border-brand-yellow outline-none text-lg">
                        </div>
                    </div>
                </div>
            </div>

            <!-- TARJETA 3: PEDIDO -->
            <div class="bg-white p-5 rounded-2xl card-soft relative overflow-hidden border-l-4 border-brand-green">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <span class="w-8 h-8 bg-green-100 text-brand-green rounded-full flex items-center justify-center mr-2 text-sm"><i class="fas fa-list"></i></span>
                        Armar Pedido
                    </h2>
                    <button onclick="addFlavor()" class="bg-brand-green text-white px-3 py-2 rounded-lg text-xs font-bold shadow hover:bg-green-800 transition active:scale-95">
                        <i class="fas fa-plus mr-1"></i> AGREGAR
                    </button>
                </div>

                <!-- Encabezados Tabla -->
                <div class="grid grid-cols-12 gap-2 text-[10px] font-black text-gray-400 mb-2 uppercase tracking-wide px-1">
                    <div class="col-span-6">Producto / Sabor</div>
                    <div class="col-span-2 text-center">Tipo</div>
                    <div class="col-span-3 text-center">Cantidad</div>
                    <div class="col-span-1"></div>
                </div>

                <!-- Filas Dinámicas -->
                <div id="flavorsContainer" class="space-y-2">
                    <!-- Aquí se inyectan los inputs con JavaScript -->
                </div>
            </div>

        </div>

        <!-- COLUMNA DERECHA: RESUMEN Y ACCIONES (4 columnas) -->
        <div class="lg:col-span-4">
            <div class="sticky top-24">
                
                <!-- Tarjeta Totalizadora Negra -->
                <div class="bg-gray-900 text-white rounded-2xl shadow-2xl p-6 relative overflow-hidden">
                    <!-- Decoración de fondo -->
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-brand-pink rounded-full opacity-20 blur-2xl"></div>
                    <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-brand-pink via-purple-500 to-brand-yellow"></div>
                    
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest text-center mb-4">Total Estimado</h3>
                    
                    <div class="flex flex-col items-center justify-center mb-6">
                        <span class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-600" id="uiTotalMoney">$0.00</span>
                        <div class="bg-gray-800 px-3 py-1 rounded-full mt-2">
                            <span class="text-xs font-mono text-gray-300" id="uiTotalQty">0 PIEZAS</span>
                        </div>
                    </div>

                    <!-- BOTÓN PRINCIPAL DE COMPARTIR -->
                    <button id="btnShare" onclick="shareTicketNative()" class="w-full bg-brand-pink hover:bg-pink-600 text-white py-4 rounded-xl font-bold shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2 group border border-pink-400">
                        <i class="fas fa-share-alt text-xl group-hover:rotate-12 transition-transform"></i>
                        <span>COMPARTIR TICKET</span>
                    </button>

                    <!-- Mensaje de estado -->
                    <div id="statusMessage" class="hidden mt-3 text-center">
                        <div class="flex items-center justify-center gap-2 text-xs text-yellow-300">
                            <i class="fas fa-circle-notch spinner"></i>
                            <span>Generando imagen HD...</span>
                        </div>
                    </div>

                    <button onclick="resetAll()" class="w-full mt-4 text-[10px] text-gray-500 uppercase font-bold hover:text-white transition flex items-center justify-center gap-1">
                        <i class="fas fa-trash"></i> Reiniciar Formulario
                    </button>
                </div>

                <div class="mt-6 text-center opacity-50">
                    <p class="text-[10px] text-gray-600 font-mono">v6.0 GitHub Edition</p>
                </div>
            </div>
        </div>
    </div>


    <!-- ========================================= -->
    <!-- TICKET OCULTO (PLANTILLA PARA IMAGEN) -->
    <!-- ========================================= -->
    <!-- 
        IMPORTANTE: 
        Este div está fuera de la pantalla (left: -9999px) pero NO tiene display:none.
        html2canvas necesita que el elemento exista visualmente para "tomarle la foto".
        Tiene un fondo blanco puro para evitar transparencias raras.
    -->
    <div id="ticketContainer" style="position: fixed; top: 0; left: -9999px; width: 480px; z-index: 100;">
        <div id="ticketContent" class="bg-white p-8 text-black relative overflow-hidden" style="width: 100%; min-height: 600px;">
            
            <!-- Marca de agua sutil -->
            <div class="absolute inset-0 opacity-[0.03]" style="background-image: url('https://www.transparenttextures.com/patterns/az-subtle.png');"></div>

            <!-- ENCABEZADO TICKET -->
            <div class="text-center border-b-4 border-black pb-4 mb-4 relative z-10">
                <h1 class="text-3xl font-black uppercase tracking-tighter leading-none mb-1">TAMALAPP</h1>
                <p class="text-xs font-bold text-gray-600 uppercase tracking-[0.3em]">Sistema de Control</p>
                
                <div class="mt-4 flex justify-between items-end">
                    <div class="text-left">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">Folio Único</p>
                        <p class="text-xl font-mono font-bold" id="ticketFolio">#00000</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">Fecha Emisión</p>
                        <p class="text-sm font-mono font-bold" id="ticketEmissionDate">--/--/--</p>
                    </div>
                </div>
            </div>

            <!-- DATOS DEL CLIENTE -->
            <div class="mb-6 font-ticket text-sm relative z-10 bg-gray-50 p-4 border border-gray-200 rounded-lg">
                <div class="mb-3">
                    <span class="text-[10px] font-bold text-gray-500 uppercase block">Cliente:</span>
                    <span id="ticketClientName" class="text-xl font-bold uppercase block leading-none">--</span>
                </div>
                
                <div class="mb-3">
                    <span class="text-[10px] font-bold text-gray-500 uppercase block">Contacto:</span>
                    <span id="ticketClientPhone" class="font-mono text-base font-bold text-gray-800">--</span>
                </div>

                <div class="border-t border-dashed border-gray-300 pt-2 mt-2">
                    <span class="text-[10px] font-bold text-red-500 uppercase block mb-1">Fecha de Entrega / Compromiso:</span>
                    <p id="ticketDeliveryInfo" class="text-lg font-bold uppercase leading-tight text-gray-800">--</p>
                </div>
            </div>

            <!-- TABLA DE PRODUCTOS -->
            <table class="w-full mb-4 font-ticket text-sm relative z-10">
                <thead>
                    <tr class="border-b-2 border-black">
                        <th class="text-left py-2 w-12">CANT</th>
                        <th class="text-left py-2">DESCRIPCIÓN</th>
                        <th class="text-right py-2 w-20">IMPORTE</th>
                    </tr>
                </thead>
                <tbody id="ticketTbody">
                    <!-- Se llena con JS -->
                </tbody>
            </table>

            <!-- TOTALES -->
            <div class="border-t-4 border-black pt-2 mb-2 relative z-10 mt-6">
                <div class="flex justify-between items-end">
                    <span class="text-2xl font-bold font-ticket">TOTAL:</span>
                    <span id="ticketTotalNum" class="text-3xl font-black font-mono">$0.00</span>
                </div>
                <div class="text-right text-[10px] font-bold text-gray-500 uppercase">Pesos Mexicanos MXN</div>
            </div>
            
            <div class="bg-gray-100 p-2 mt-2 relative z-10">
                <p class="text-[9px] font-bold text-gray-500 uppercase">Importe con Letra:</p>
                <p id="ticketTotalLetters" class="text-xs font-mono font-bold uppercase leading-tight">CERO PESOS 00/100 M.N.</p>
            </div>

            <!-- PIE DE TICKET -->
            <div class="text-center text-[10px] font-ticket text-gray-400 mt-10 pt-4 border-t border-gray-300 relative z-10">
                <p class="font-bold mb-8 uppercase tracking-widest">*** GRACIAS POR SU PREFERENCIA ***</p>
                
                <div class="flex justify-center">
                    <div class="border-t border-black w-40 pt-1">
                        <p class="text-black font-bold">Firma de Conformidad</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- LÓGICA JAVASCRIPT -->
    <!-- ========================================= -->
    <script>
        // --- 1. ESTADO DE LA APLICACIÓN ---
        // Aquí definimos los sabores iniciales. Nota que "Blancos" es el ID 4.
        let flavors = [
            { id: 1, name: 'Verde', type: 'general', qty: 0 },
            { id: 2, name: 'Mole', type: 'general', qty: 0 },
            { id: 3, name: 'Rajas', type: 'general', qty: 0 },
            { id: 4, name: 'Blancos', type: 'special', qty: 0 }
        ];

        // --- 2. INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            renderFlavors();
            setInitialDates();
            generateRandomFolio();
        });

        function setInitialDates() {
            const now = new Date();
            // Formato YYYY-MM-DD para el input date
            const todayISO = now.toISOString().split('T')[0];
            const deliveryInput = document.getElementById('deliveryDate');
            if(deliveryInput) deliveryInput.value = todayISO;

            // Fecha bonita para el header
            const headerDate = document.getElementById('systemHeaderDate');
            if(headerDate) {
                headerDate.innerText = now.toLocaleDateString('es-MX');
            }
        }

        function generateRandomFolio() {
            // Genera un folio aleatorio entre 10000 y 99999
            const folio = Math.floor(10000 + Math.random() * 90000);
            document.getElementById('ticketFolio').innerText = `#${folio}`;
        }

        // --- 3. RENDERIZADO DE SABORES (TABLA DE ENTRADA) ---
        function renderFlavors() {
            const container = document.getElementById('flavorsContainer');
            container.innerHTML = ''; // Limpiar contenedor

            flavors.forEach((item, index) => {
                const isFixed = index < 4; // Los primeros 4 no se pueden borrar
                
                // Crear fila
                const row = document.createElement('div');
                row.className = "grid grid-cols-12 gap-2 items-center bg-white p-2 rounded-lg border border-gray-100 shadow-sm transition hover:border-brand-pink";

                row.innerHTML = `
                    <div class="col-span-6">
                        ${isFixed 
                            ? `<span class="font-bold text-gray-700 pl-2 text-xs md:text-sm uppercase block truncate">${item.name}</span>` 
                            : `<input type="text" value="${item.name}" onchange="updateFlavorName(${index}, this.value)" class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-xs font-bold text-gray-700 uppercase outline-none focus:border-brand-pink" placeholder="NOMBRE SABOR">`
                        }
                    </div>
                    <div class="col-span-2">
                        <select onchange="updateFlavorType(${index}, this.value)" class="w-full text-[10px] bg-gray-50 border border-gray-200 rounded py-1 px-0 font-bold text-gray-500 outline-none text-center focus:border-brand-pink">
                            <option value="general" ${item.type === 'general' ? 'selected' : ''}>GEN</option>
                            <option value="special" ${item.type === 'special' ? 'selected' : ''}>ESP</option>
                        </select>
                    </div>
                    <div class="col-span-3">
                        <input type="number" min="0" value="${item.qty}" oninput="updateFlavorQty(${index}, this.value)" class="w-full text-center font-bold text-lg bg-white border-b-2 border-gray-200 focus:border-brand-pink outline-none text-gray-800 py-0">
                    </div>
                    <div class="col-span-1 flex justify-center">
                        ${!isFixed 
                            ? `<button onclick="removeFlavor(${index})" class="text-red-400 hover:text-red-600 transition"><i class="fas fa-times-circle"></i></button>` 
                            : ``
                        }
                    </div>
                `;
                container.appendChild(row);
            });
            recalculate(); // Recalcular totales al renderizar
        }

        // --- 4. FUNCIONES LOGICAS (CRUD) ---
        function addFlavor() {
            flavors.push({ id: Date.now(), name: '', type: 'general', qty: 0 });
            renderFlavors();
        }

        function removeFlavor(index) {
            flavors.splice(index, 1);
            renderFlavors();
        }

        function updateFlavorName(index, val) { flavors[index].name = val; }
        function updateFlavorType(index, val) { flavors[index].type = val; recalculate(); }
        function updateFlavorQty(index, val) { flavors[index].qty = parseInt(val) || 0; recalculate(); }

        // --- 5. CÁLCULO MATEMÁTICO ---
        function recalculate() {
            const priceGen = parseFloat(document.getElementById('priceGeneral').value) || 0;
            const priceSpec = parseFloat(document.getElementById('priceSpecial').value) || 0;
            
            let totalQty = 0;
            let totalMoney = 0;

            flavors.forEach(f => {
                if(f.qty > 0) {
                    const price = f.type === 'general' ? priceGen : priceSpec;
                    totalQty += f.qty;
                    totalMoney += (f.qty * price);
                }
            });

            // Actualizar interfaz del resumen (tarjeta negra)
            document.getElementById('uiTotalQty').innerText = totalQty + " PIEZAS";
            document.getElementById('uiTotalMoney').innerText = formatMoney(totalMoney);

            return { totalQty, totalMoney, priceGen, priceSpec };
        }

        // --- 6. FUNCIÓN DE COMPARTIR NATIVO (LA JOYA DE LA CORONA) ---
        async function shareTicketNative() {
            // A. Validaciones
            const customer = document.getElementById('customerName').value.trim();
            const calc = recalculate();

            if (!customer) return alert("❌ Por favor, escribe el nombre del cliente.");
            if (calc.totalQty === 0) return alert("❌ El pedido está vacío.");

            // B. Mostrar spinner de carga
            const btn = document.getElementById('btnShare');
            const status = document.getElementById('statusMessage');
            btn.disabled = true;
            btn.classList.add('opacity-50');
            status.classList.remove('hidden');

            try {
                // C. Rellenar los datos en el Ticket HTML Oculto
                fillTicketData(customer, calc);

                // D. Esperar un momento para que el DOM se actualice
                await new Promise(resolve => setTimeout(resolve, 300));

                // E. Convertir HTML a Canvas y luego a Blob
                const ticketEl = document.getElementById('ticketContent');
                const canvas = await html2canvas(ticketEl, {
                    scale: 2, // Alta resolución
                    backgroundColor: '#ffffff', // Asegurar fondo blanco
                    useCORS: true // Para cargar texturas si las hubiera
                });

                // F. Convertir Canvas a Archivo (File Object)
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        throw new Error("No se pudo generar la imagen");
                    }

                    // Crear nombre de archivo limpio
                    const safeName = customer.replace(/[^a-z0-9]/gi, '_').substring(0, 15);
                    const fileName = `Pedido_${safeName}.png`;
                    
                    // Crear objeto Archivo compatible con Share API
                    const file = new File([blob], fileName, { type: 'image/png' });

                    // G. INVOCAR EL COMPARTIR NATIVO (El Cajón)
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: 'Ticket de Pedido',
                                text: `Hola ${customer}, aquí está tu ticket de pedido.`
                            });
                            // Si tuvo éxito:
                            console.log("Compartido con éxito");
                        } catch (shareError) {
                            if (shareError.name !== 'AbortError') {
                                console.error('Error al compartir:', shareError);
                                alert("No se pudo abrir el cajón de compartir. Intentando descarga manual...");
                                forceDownload(blob, fileName);
                            }
                        }
                    } else {
                        // Fallback para PC o navegadores viejos
                        alert("⚠️ Tu navegador no soporta compartir imagen directa. Se descargará la imagen.");
                        forceDownload(blob, fileName);
                    }

                    // Restaurar botón
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                    status.classList.add('hidden');

                }, 'image/png');

            } catch (error) {
                console.error(error);
                alert("Hubo un error generando el ticket: " + error.message);
                btn.disabled = false;
                btn.classList.remove('opacity-50');
                status.classList.add('hidden');
            }
        }

        // Función auxiliar para rellenar datos del ticket antes de la foto
        function fillTicketData(customer, calc) {
            const now = new Date();
            
            // Fechas
            document.getElementById('ticketEmissionDate').innerText = now.toLocaleString('es-MX');
            
            // Cliente
            document.getElementById('ticketClientName').innerText = customer;
            
            // Teléfonos
            const p1 = document.getElementById('customerPhone1').value;
            const p2 = document.getElementById('customerPhone2').value;
            let phones = p1 || "Sin teléfono";
            if (p2) phones += " / " + p2;
            document.getElementById('ticketClientPhone').innerText = phones;

            // Entrega
            const dDate = document.getElementById('deliveryDate').value;
            const dTime = document.getElementById('deliveryTime').value;
            let deliveryText = "SIN FECHA DEFINIDA";
            
            if (dDate) {
                const [y, m, d] = dDate.split('-');
                // Crear fecha manual para evitar problemas de zona horaria
                const dateObj = new Date(y, m - 1, d);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                deliveryText = dateObj.toLocaleDateString('es-MX', options).toUpperCase();
                
                if (dTime) {
                    // Convertir hora 24h a 12h
                    const [th, tm] = dTime.split(':');
                    const h = parseInt(th);
                    const suffix = h >= 12 ? 'PM' : 'AM';
                    const h12 = h % 12 || 12;
                    deliveryText += ` A LAS ${h12}:${tm} ${suffix}`;
                }
            }
            document.getElementById('ticketDeliveryInfo').innerText = deliveryText;

            // Tabla Items
            const tbody = document.getElementById('ticketTbody');
            tbody.innerHTML = '';
            
            flavors.forEach(f => {
                if (f.qty > 0) {
                    const price = f.type === 'general' ? calc.priceGen : calc.priceSpec;
                    const subtotal = f.qty * price;
                    
                    const row = `
                        <tr class="border-b border-dotted border-gray-400">
                            <td class="py-2 align-top font-bold text-lg">${f.qty}</td>
                            <td class="py-2 align-top">
                                <span class="block uppercase font-bold text-sm">${f.name || 'SABOR'}</span>
                                <span class="text-[10px] text-gray-500 font-mono">$${price} c/u</span>
                            </td>
                            <td class="py-2 align-top text-right font-bold text-lg">$${formatMoney(subtotal).replace('$','')}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            });

            // Totales
            document.getElementById('ticketTotalNum').innerText = formatMoney(calc.totalMoney);
            document.getElementById('ticketTotalLetters').innerText = numeroALetras(calc.totalMoney);
        }

        // Descarga manual por si falla el compartir nativo
        function forceDownload(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Limpiar formulario
        function resetAll() {
            if(confirm("¿Estás seguro de borrar todos los datos del formulario?")) {
                document.getElementById('customerName').value = '';
                document.getElementById('customerPhone1').value = '';
                document.getElementById('customerPhone2').value = '';
                document.getElementById('deliveryTime').value = '';
                
                flavors.forEach(f => f.qty = 0);
                // Reset flavors (mantener los 4 base)
                flavors = flavors.filter((f, i) => i < 4);
                // Reset names for base flavors just in case
                flavors[0].name = 'Verde';
                flavors[1].name = 'Mole';
                flavors[2].name = 'Rajas';
                flavors[3].name = 'Blancos';
                
                renderFlavors();
                generateRandomFolio();
            }
        }

        // --- UTILIDADES DE FORMATO ---
        function formatMoney(amount) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
        }

        function numeroALetras(cantidad) {
            // Función simplificada pero efectiva para tickets
            const numero = parseFloat(cantidad);
            if (isNaN(numero)) return '';
            
            const parteEntera = Math.floor(numero);
            const parteDecimal = Math.round((numero - parteEntera) * 100);
            
            let letras = convertirEntero(parteEntera);
            
            // Ajustes gramaticales
            if (parteEntera === 1) letras = "UN";
            
            const centavosStr = parteDecimal.toString().padStart(2, '0');
            const monedaStr = parteEntera === 1 ? "PESO" : "PESOS";
            
            return `${letras} ${monedaStr} ${centavosStr}/100 M.N.`;
        }

        function convertirEntero(num) {
            if (num === 0) return "CERO";
            
            const unidades = ["", "UN", "DOS", "TRES", "CUATRO", "CINCO", "SEIS", "SIETE", "OCHO", "NUEVE"];
            const decenas = ["", "DIEZ", "VEINTE", "TREINTA", "CUARENTA", "CINCUENTA", "SESENTA", "SETENTA", "OCHENTA", "NOVENTA"];
            const especiales = ["DIEZ", "ONCE", "DOCE", "TRECE", "CATORCE", "QUINCE", "DIECISEIS", "DIECISIETE", "DIECIOCHO", "DIECINUEVE"];
            const centenas = ["", "CIENTO", "DOSCIENTOS", "TRESCIENTOS", "CUATROCIENTOS", "QUINIENTOS", "SEISCIENTOS", "SETECIENTOS", "OCHOCIENTOS", "NOVECIENTOS"];

            if (num < 10) return unidades[num];
            if (num < 20) return especiales[num - 10];
            if (num < 30) return "VEINTI" + unidades[num - 20];
            if (num < 100) return decenas[Math.floor(num / 10)] + (num % 10 !== 0 ? " Y " + unidades[num % 10] : "");
            
            if (num < 1000) {
                if (num === 100) return "CIEN";
                return centenas[Math.floor(num / 100)] + (num % 100 !== 0 ? " " + convertirEntero(num % 100) : "");
            }
            
            if (num < 1000000) {
                const miles = Math.floor(num / 1000);
                const resto = num % 1000;
                let textoMiles = (miles === 1 ? "UN" : convertirEntero(miles)) + " MIL";
                return textoMiles + (resto !== 0 ? " " + convertirEntero(resto) : "");
            }
            
            return "CANTIDAD MUY GRANDE";
        }
    </script>
</body>
</html>
